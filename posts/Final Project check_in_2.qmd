---
title: "Final Project check-in 2"
author: "Diana Rinker"
description: "Final project DACSS 603"
date: "4/17/2023"
format:
  html:
    toc: true
    code-fold: true
    code-copy: true
    code-tools: true
editor: 
  markdown: 
    wrap: 72
---

## DACSS 603, spring 2023

## Final Project check-in 2, Diana Rinker.

# Online engagement

It is well known that online engagement with the web resource is a
highly valuable metric and is driving site revenue. However, engagement
and popularity might also be associated with other factors, that
websties are trying to avoid, such as online violence, inappropriate
behavior and misinformation.This research project is exploring whith
factos impact readers engagement in social media conversations.

To do that I will use the data from an online blog on the news website.
The author of this blog is posting weekly articles about interpersonal
relationships, that are formulated as a letter to to the author, where
the author gives an advice about the situation. Readers are free to
comment under each post, but cannot make their own posts.

Using this data set, I will explore how engagement of readers of a news
blog connected with variety of factors, such blogs's author engagement ,
topic of the post, source of readers and readers inappropriate online
behavior.

My research question is: Does the authors engagement in the conversation
around the post makes readers more engaged and promotes positive
interactions among them?

**DV:** My dependent construct is **"user's engagement**", I will
measure users' engagement at the level of individual post, using the
following variables

L1 - page viewers View page

L2 - page readers \* Reveal letter \* Reveal comments

L3 - logged in \* Login / sign up \* Up / down vote

L4 - commenter Comment

**IV:** My main independent variable is **Blog's author engagement.** I
will measure authors engagement as the factor variable, with the
following levels:

A. Unspecified comment

B. Featured comment

C. Engagement in conversation

To control for **confounders,** I will also measure the follwing
variables:

1.  Topic of the post ("post tag"), categorical variable.

2.  Source of the readers, also categorical variable.

3.  Mood of the conversation , derivative continuous variable calculated
    as the ratio of "likes" to "dislikes".

4.  Blocked and flagged comments.

```{r, echo=F}
#Loading necessary libraries: 
library(readxl)
library(dplyr)
library(ggplot2)
library(tidyverse)
```

# Data

To answer my research question I will use two datasets. the first data
set has information about all comments associated with each post by post
ID. The second data set is analytics data for the web bage. It contains
one post per row and variables describe each post as a whole without
breaking down to the comment level.

In this project I will analyze posts for January 2021 - February 2023.

First, I will load the data set with the comment level data:

```{r, echo=T}
getwd()
raw <- as_tibble (read_csv("C:\\Users\\Diana\\OneDrive - University Of Massachusetts Medical School\\Documents\\R\\R working directory\\DACSS\\603\\my study files for dacss603\\globe\\ data.2021.plus.csv"))

comments.data<-raw 
colnames (comments.data)
head(comments.data$written_at)
comments.data <-comments.data%>%
              mutate(com.year = format(written_at,format = "%Y" ))
range(comments.data$com.year)
dim(comments.data)
```

Second, loadng post-level data :
```{r, echo=T}

merged <- as_tibble (read_csv("C:\\Users\\Diana\\OneDrive - University Of Massachusetts Medical School\\Documents\\R\\R working directory\\DACSS\\603\\my study files for dacss603\\globe\\data.merged.csv"))
# colnames(merged)
# str(merged)
```


\# Variable description

To begin, I will review available variables and describe how I will use
them to measure my constructs.

\### Dependent variable. User engagement.

My dependent construct is \*\*user's engagement\*\*, I will measure
users

engagement at the level of individual post. There are following metrics
that I could use for engagement. Each of them represent a different
aspect of eaders engagement. I will review existing data on these
measures and , based on their variability , will select which one is to
use as DV for my hypothesis.

Engagement metrics

The levels below could be used to describe individual user's engagement
at the time of the viusit of the site.

L1 - page viewers View page

L2 - page readers

\\\* Reveal letter

\\\* Reveal comments

L3 - logged in

\\\* Login / sign up

\\\* Up / down vote

L4 - commenter Comments

the following metrics could lso be considered a way to measure ngagement
at the post level:

Exit rate per post: represents number of people who visited the page
only and then left the website (oppsed to staying on the website and
reading other articles).


# Engagement (DV) metrics: 

### Page views
This is the most general engagement metric,  representing how many views the post received. 


```{r, echo=T}
# str(merged)
merged$post.month <-as.numeric(merged$post.month)
merged$year_month <- paste0(merged$post.year, "-", sprintf("%02d", merged$post.month))

ggplot( data=merged, mapping=aes(y=`Page views`, x=merged$year_month))+
          geom_boxplot()+
  labs(title="Number of post wiews per month", x="Month", y="Number of vews")+ 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


```
From this graph we can see that the numbers of views is increasing with time


### Number of comments

```{r, echo=T}
# merged$year_month 
ggplot(merged, mapping = aes(x=year_month , y=n.comments, fill=year_month ))+
  geom_boxplot() +
  labs(title = "distribution of comments per post ", y = "Number of comments" )+
  scale_y_continuous(breaks = seq (from=0, to= 10000, by= 100)) + 
     theme(axis.text.x = element_text(angle = 45, hjust = 1))
   

```

### Exit rate 

```{r, echo=T}
# str(merged)
merged$`Exit rate` <- as.numeric(sub("%", "", merged$`Exit rate`)) / 100
ggplot(merged, mapping = aes(x=year_month , y=`Exit rate`, fill=year_month ))+
  geom_boxplot() +
  labs(title = "distribution of `Exit rate` per post ", y = "Exit rate" , x="Month")+ 
     theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

##Independent variables (IV):

#### Authors comments
To identify, how much the author of the bblog is engaged in the post,  I will create an additional variable derived from a user_name field. 


```{r, echo=T}
# str(merged)
comments.data$user_name<-  ifelse (is.na(comments.data$user_name), 0, comments.data$user_name)
comments.data$author<-  ifelse (comments.data$user_name=="MeredithGoldstein", 1, 0)

comments.grouped <-comments.data %>%
  group_by(post_id)%>%
  summarize(n.comments=n(),
            author.sum = sum(author))

# dim(comments.grouped )
# colnames(comments.grouped )
# class(comments.grouped$author.sum)

# Comments data contains rows that dont actually reporesent posts, and were crearted by web support team for troubleshooting. I need to remove these rows. They typically have very low number of comments
comments.grouped <-comments.grouped %>%
filter(n.comments >100)  # removing invalid posts created by the  website management team.

comments.grouped <-comments.grouped %>%
  select(post_id, author.sum)
 dim(comments.grouped)
 
 
#adding author.sum to main data set: 
merged <- merge( merged , comments.grouped, by = "post_id", all = TRUE)

ggplot(merged, mapping = aes(x=year_month , y=author.sum, fill=year_month ))+
  geom_boxplot() +
  labs(title = "distribution of Author's comments by months", y = "Author's comments" , x="Month")+ 
     theme(axis.text.x = element_text(angle = 45, hjust = 1))

```



### Mood of the post.

This is a numerical variable, calculated as percentage of "thumbs up" from all likes (both "thumbs up" and "thumbs down"). 

```{r, echo=T}
ggplot(merged, mapping = aes(x=year_month , y=pct.positive, fill=year_month ))+
  geom_boxplot() +
  labs(title = "distribution of Mood per post ", y = "Mood" , x="Month")+ 
     theme(axis.text.x = element_text(angle = 45, hjust = 1))


```

### Blocked comments per post.

Now I will visualize amount of blocked comments per post:

```{r, echo=T}

ggplot(merged, mapping = aes(x=year_month , y=blocked.sum, fill=year_month ))+
  geom_boxplot() +
  labs(title = "Number Blocked comments  per post ", y = "Number of blocked comments per post" , x="Month")+ 
     theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
### Views vs visits vs users:
Views - represent the number of times page was viewed by all users at all times.
Visit - is an insance of a user engaging with bdc website. There can be many visits by the same viewer. Once th user is leaving the website, the visit is over. 
To count unique viewers, we can use "Uniques" variable. It tells us how many unique users saw the post. 

Lets review how these three variables correspond to each other, to better understand which variable  to use for our analysis: 

```{r, echo=T}

 ggplot(merged, aes(x =post.date )) +
     geom_bar(aes(y = `Page views`, fill = "Page views"), stat = "identity", position = "dodge", width = 0.6) +
     geom_bar(aes(y = Visits, fill = "Visits"), stat = "identity", position = "dodge", width = 0.6) +
     geom_bar(aes(y = Uniques, fill = "Unique users"), stat = "identity", position = "dodge", width = 0.6)    +
     labs(title = "Views, visits and unique users per month", x = "Post.date", y = "Value") + 
     theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

To get a better understanding of the dynamic of these metircs over time,  I will calculate the ratio of unique users per page views. 
   # Calculation relation of views/unique users. Lower value of unique.ratio indicates that more posts were re-viewed by repeated users.
 
```{r, echo=T}
  merged <- merged %>%
     mutate(uniques.ratio = Uniques / `Page views`)
# str(merged)
```   
 Now I will plot this to see change over time: 
```{r, echo=T}
     ggplot(merged, aes( y = uniques.ratio, x =post.date, )) +
          geom_point(color ="blue" )    +
          labs(title = "Unique.ratio per post ", x = "Post.date", y = "Value") + 
          theme(axis.text.x = element_text(angle = 45, hjust = 1))  

```
Now I calculate ration of visits per post views:

```{r, echo=T}
  merged <- merged %>%
     mutate(visits.ratio = Visits / `Page views`)
str(merged)

ggplot(merged, aes( y = visits.ratio, x =post.date, )) +
          geom_point(color ="purple" )    +
          labs(title = "Uvisits.ratio per post ", x = "Post.date", y = "Value") + 
          theme(axis.text.x = element_text(angle = 45, hjust = 1))  

```

And will see how these values correlate: 


```{r, echo=T}
correlation <- cor(merged$uniques.ratio, merged$visits.ratio)
correlation
plot(merged$uniques.ratio, merged$visits.ratio)

```
This graph shows the there are some posts that are visited once or very few times by unique users, and some posts are being re-visited by the repeated users. 



### Referral sources:
The web analytics provides information on where the viewers are coming from  to the LL page. There  are 5 sources of referrals, each corresponding with a variable in the data set.

            "Search + amp referral visits"
            "Direct (non-email) referral visits"
            "Other website referral visits"
            "Social referral visits"
            "BDC referral visits"
            "Visits when post was on LL HP" 

```{r, echo=T}
merged<-merged%>%
  rename(google ="Search + amp referral visits",
         direct ="Direct (non-email) referral visits",
         other.web = "Other website referral visits",
          social= "Social referral visits",
          bdc= "BDC referral visits",
          ll= "Visits when post was on LL HP" )

ggplot(merged, mapping=aes(x=post.date))+
  geom_point(aes(y=google), color="red")+
  geom_point(aes(y=direct), color="green")+
  geom_point(aes(y=other.web), color="yellow")+
  geom_point(aes(y=social), color="purple")+
  geom_point(aes(y=bdc), color="blue")+
  geom_point(aes(y=ll), color="pink")
  
  +
  labs(title = "referral sources per post ", y = "Number of referrals" , x="Post")+ 
     theme(axis.text.x = element_text(angle = 45, hjust = 1))
```



# Analysis 
First,  I will use "page views"  as dependent variable and regress it against all other independent variable: 

##Page views as DV
```{r, echo=T}
colnames(merged)
summary(lm(`Page views` ~ pct.positive+author.sum +uniques.ratio +visits.ratio +blocked.sum, data = merged))

```

## Number of comments as DV
```{r, echo=T}
colnames(merged)
summary(lm(n.comments ~ pct.positive+author.sum +uniques.ratio +visits.ratio +blocked.sum, data = merged))

```

## Exit rate as DV
```{r, echo=T}
colnames(merged)
summary(lm(`Exit rate`~ pct.positive+author.sum +uniques.ratio +visits.ratio +blocked.sum, data = merged))

```
##Page views as DV


```{r, echo=T}
colnames(merged)
summary(lm(google~ ll, data = merged))
summary(lm(google~ n.comments, data = merged))
summary(lm(google~ Uniques, data = merged))


```



### Blocked comments and Post mood:

```{r, echo=T}

plot(blocked.sum ~ mood.score, data= grouped )
  
  
summary(grouped)  

fit <- lm(blocked.sum ~ mood.score, data = grouped)

sum(is.na(grouped$mood.score))

summary(fit)

  
```

### 

This variable indicates the date of the comment. Using the range of the
dates per post, I can estimate how long each post was in active
discussion. 

```{r, echo=T}


```

### Second wave causes:

Some posts demonstrate increased amount of views, coming from search engines. These views are coming 2-3 ays after the post date (ADD DATA HERE ). 

We are interested to find out, what characteristics of the post (prior to it being picked up by google), correlate with its appearance on google news. 


Number of comments within 1st 10 hours from the post -> google wave 
Number of unique commentors in first 10 hours -> google wave 


```{r, echo=T}
# MG.comments<-comments.2022[grep("MeredithGoldstein", comments.2022$user_name, ignore.case = TRUE), ]
post.dates<-merged%>%
  select(post_id,post.date)
dim(comments.data)
comments.data <- merge( comments.data , post.dates, by = "post_id", all = TRUE)


class(comments.data$written_at)
class(comments.data$post.date)

comments.data <- comments.data %>%
  ungroup()%>%
  mutate (post_age= written_at - post.date)
  
colnames(comments.data)
colnames(merged)
```

comments.data









